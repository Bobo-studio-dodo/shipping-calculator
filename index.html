<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bobo Studio äºŒè£œè¨ˆåƒ¹å™¨</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; background-color: #f4f4f9; color: #333; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #444; margin-bottom: 1.5rem; }
        
        .section { margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #eee; border-radius: 8px; background-color: #fafafa; }
        
        /* æ™ºæ…§è­˜åˆ¥å€æ¨£å¼ */
        .smart-parse-area { border: 2px dashed #6f42c1; background-color: #f8f3ff; }
        .smart-parse-area h3 { color: #6f42c1; display: flex; align-items: center; gap: 10px; }
        .smart-btn { background-color: #6f42c1; color: white; width: 100%; margin-top: 10px; }
        .smart-btn:hover { background-color: #5a32a3; }

        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-group { flex: 1; }
        label { display: block; margin-bottom: 0.5rem; font-weight: bold; font-size: 0.9rem; }
        input, textarea, select { width: 100%; padding: 0.8rem; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        textarea { resize: vertical; height: 60px; font-family: monospace; }
        
        button { padding: 0.8rem 1.5rem; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-primary { background-color: #007bff; color: white; width: 100%; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-success { background-color: #28a745; color: white; width: 100%; }
        .btn-danger { background-color: #dc3545; color: white; padding: 5px 10px; font-size: 0.8rem; }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #f1f1f1; white-space: nowrap; }
        
        #clipboardArea { position: absolute; left: -9999px; }
        .note { font-size: 0.85rem; color: #888; margin-top: 5px; }
        
        /* æ–°å¢ï¼šåŒ…è£¹æ•¸é‡é¡¯ç¤º */
        #pkgCountDisplay { color: #d63384; font-weight: bold; margin-top: 5px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¦ äºŒè£œè¨ˆåƒ¹å™¨ (æ‰“åŒ…åˆ†é›¢ç‰ˆ)</h2>
    
    <div class="section">
        <div class="form-row">
            <div class="form-group">
                <label>æ¯å…¬æ–¤å–®åƒ¹ (TWD)</label>
                <input type="number" id="pricePerKg" value="68">
            </div>
            <div class="form-group">
                <label>æœ¬æ‰¹æ¬¡åç¨± (Sheetç”¨)</label>
                <input type="text" id="batchName" placeholder="ä¾‹å¦‚ï¼š1æœˆç¬¬2æ‰¹">
            </div>
        </div>
    </div>

    <div class="section smart-parse-area">
        <h3>ğŸª„ æ™ºæ…§è²¼ä¸Šå€</h3>
        <p class="note" style="margin-bottom: 10px;">ç›´æ¥è²¼ä¸Šæ•´æ®µè¨Šæ¯ (åŒ…å«Emailã€ç·¨è™Ÿã€é‡é‡)ï¼Œç³»çµ±æœƒè‡ªå‹•æŠ“å–å¡«å…¥ä¸‹æ–¹æ¬„ä½ã€‚</p>
        <textarea id="smartInput" 
placeholder="ä¾‹å¦‚ï¼š
æœƒå“¡ï¼šB001 å°æ˜
ä¿¡ç®±ï¼šming@gmail.com
åŒ…è£¹ï¼š0.5 1.2
å‚™è¨»ï¼šæ˜“ç¢å“" style="height: 100px;"></textarea>
        <button class="smart-btn" onclick="parseSmartInput()">â¬‡ï¸ è‡ªå‹•è­˜åˆ¥ä¸¦å¡«å…¥ä¸‹æ–¹</button>
    </div>

    <div class="section" style="background-color: #eef6ff; border-color: #b8daff;">
        <h3>â• ç¢ºèªèˆ‡æ–°å¢åŒ…è£¹</h3>
        <div class="form-row">
            <div class="form-group" style="flex: 0.5;">
                <label>æœƒå“¡ç·¨è™Ÿ</label>
                <input type="text" id="memberId" placeholder="è‡ªå‹•è­˜åˆ¥">
            </div>
            <div class="form-group">
                <label>æœƒå“¡ Gmail</label>
                <input type="email" id="memberEmail" placeholder="è‡ªå‹•è­˜åˆ¥">
            </div>
        </div>
        
        <div class="form-group">
            <label>å…¥åº«åŒ…è£¹é‡é‡ (ç©ºç™½éµåˆ†éš”)</label>
            <textarea id="weightInput" placeholder="ä¾‹å¦‚ï¼š0.25 0.75" oninput="updatePkgCount()"></textarea>
            <span id="pkgCountDisplay">ç›®å‰å…¥åº«ï¼š0 ä»¶ (ä»£æ”¶è²»ä¾æ­¤è¨ˆç®—)</span>
        </div>

        <div class="form-row" style="background: #fff; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
            <div class="form-group">
                <label style="color:#d63384;">ğŸ“¦ æ‰“åŒ…å¾Œç¸½ä»¶æ•¸ (å‡ºè²¨ç®±æ•¸)</label>
                <input type="number" id="packedCount" value="1" min="1" onchange="updateTotalPreview()">
                <p class="note">1ä»¶æ”¶10å…ƒï¼Œ2ä»¶ä»¥ä¸Šæ¯ä»¶8å…ƒ</p>
            </div>
            <div class="form-group" style="display: flex; align-items: center; justify-content: flex-end;">
                 <h4 style="margin:0; color:#007bff;" id="previewTotal">é ä¼°: 0 å…ƒ</h4>
            </div>
        </div>

        <div class="form-group">
            <label>å‚™è¨»</label>
            <input type="text" id="manualNote" placeholder="æ‰‹å‹•è¼¸å…¥æˆ–è‡ªå‹•è­˜åˆ¥">
        </div>

        <button class="btn-primary" onclick="addToList()">åŠ å…¥æ¸…å–®</button>
    </div>

    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3>ğŸ“‹ å¾…è¤‡è£½æ¸…å–®</h3>
            <button class="btn-danger" onclick="clearList()">æ¸…ç©ºåˆ—è¡¨</button>
        </div>
        
        <table id="resultTable">
            <thead>
                <tr>
                    <th>ç·¨è™Ÿ</th>
                    <th>Gmail</th>
                    <th>å…¥åº«/å‡ºè²¨</th>
                    <th>è²»ç”¨æ˜ç´° (é‹/ä»£/åŒ…)</th>
                    <th>å‚™è¨»</th>
                    <th>ç¸½é‡‘é¡</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="listBody"></tbody>
        </table>
        
        <br>
        <button class="btn-success" onclick="copyExcelFormat()">è¤‡è£½ Excel æ ¼å¼</button>
        <p class="note" style="text-align: center;">é»æ“Šå¾Œï¼Œè«‹å» Google Sheet çš„ã€ŒAæ¬„ã€è²¼ä¸Š (Ctrl+V)</p>
    </div>
</div>

<textarea id="clipboardArea"></textarea>

<script>
    let dataList = [];

    // --- âœ¨ æ™ºæ…§è­˜åˆ¥é‚è¼¯ ---
    function parseSmartInput() {
        let text = document.getElementById('smartInput').value;
        if (!text) return;

        // 1. æŠ“å– Email
        const emailMatch = text.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/);
        if (emailMatch) {
            document.getElementById('memberEmail').value = emailMatch[0];
            text = text.replace(emailMatch[0], " ");
        }

        // 2. æŠ“å–é‡é‡
        const weightMatches = text.match(/\d+\.\d+/g);
        if (weightMatches) {
            document.getElementById('weightInput').value = weightMatches.join(' ');
            weightMatches.forEach(w => { text = text.replace(w, " "); });
        }

        // 3. æŠ“å–æœƒå“¡ç·¨è™Ÿ
        const idMatch = text.match(/(?<!\d)\d{4}(?!\d)/);
        if (idMatch) {
            document.getElementById('memberId').value = idMatch[0];
        } else {
            const oldIdMatch = text.match(/[A-Za-z]\d{3,4}/);
            if (oldIdMatch) document.getElementById('memberId').value = oldIdMatch[0].toUpperCase();
        }

        // 4. æŠ“å–å‚™è¨»
        const noteMatch = text.match(/(?:å‚™è¨»|Note)[:ï¼š]\s*(.*)/i);
        if (noteMatch) {
            document.getElementById('manualNote').value = noteMatch[1].trim();
        }

        updatePkgCount();
    }

    // --- ğŸ“¦ å³æ™‚æ›´æ–°é¡¯ç¤ºèˆ‡é è¦½é‡‘é¡ ---
    function updatePkgCount() {
        const weightStr = document.getElementById('weightInput').value.trim();
        let count = 0;
        if (weightStr) {
            const weights = weightStr.split(/\s+/).map(num => parseFloat(num)).filter(n => !isNaN(n));
            count = weights.length;
        }
        
        let hint = (count >= 5) ? "(ä»£æ”¶è²»é™ç‚º8å…ƒ/ä»¶)" : "(ä»£æ”¶è²»10å…ƒ/ä»¶)";
        document.getElementById('pkgCountDisplay').innerText = `ç›®å‰å…¥åº«ï¼š${count} ä»¶ ${hint}`;
        
        updateTotalPreview();
    }

    function updateTotalPreview() {
        // ç‚ºäº†è®“ä½ åœ¨æŒ‰ã€ŒåŠ å…¥ã€å‰å°±èƒ½çœ‹åˆ°é‡‘é¡ï¼Œé€™è£¡åšå€‹ç°¡å–®é ç®—
        const fee = calculateFee(true); // true ä»£è¡¨æ˜¯é è¦½æ¨¡å¼ï¼Œä¸å½ˆçª—
        if(fee) {
            document.getElementById('previewTotal').innerText = `é ä¼°: ${fee.total} å…ƒ`;
        } else {
            document.getElementById('previewTotal').innerText = `é ä¼°: 0 å…ƒ`;
        }
    }

    // --- ğŸ’° è¨ˆç®—æ ¸å¿ƒ (ç¨ç«‹å‡ºä¾†æ–¹ä¾¿é è¦½ç”¨) ---
    function calculateFee(isPreview = false) {
        const pricePerKg = parseFloat(document.getElementById('pricePerKg').value) || 0;
        const weightStr = document.getElementById('weightInput').value.trim();
        const packedCount = parseInt(document.getElementById('packedCount').value) || 1;

        if (!weightStr) return null;

        const weights = weightStr.split(/\s+/).map(num => parseFloat(num)).filter(n => !isNaN(n));
        if (weights.length === 0) return null;

        // 1. åŸºç¤æ•¸æ“š
        const inputCount = weights.length; // å…¥åº«ä»¶æ•¸ (ç®—ä»£æ”¶è²»)
        const actualWeight = weights.reduce((a, b) => a + b, 0);
        const chargeableWeight = actualWeight < 0.5 ? 0.5 : actualWeight; 

        // 2. é‹è²»
        const shippingFee = Math.ceil(chargeableWeight * pricePerKg);

        // 3. ä»£æ”¶è²» (ä¾æ“šå…¥åº«ä»¶æ•¸)
        let collectionRate = (inputCount >= 5) ? 8 : 10;
        const collectionFee = inputCount * collectionRate;

        // 4. åŒ…è£è²» (ä¾æ“šæ‰“åŒ…å¾Œä»¶æ•¸) ğŸ”¥ ä¿®æ”¹é‡é»
        let packagingFee = 0;
        if (packedCount === 1) {
            packagingFee = 10;
        } else {
            packagingFee = packedCount * 8;
        }

        const totalCost = shippingFee + collectionFee + packagingFee;

        return {
            inputCount,
            packedCount,
            weight: chargeableWeight.toFixed(2),
            shippingFee,
            collectionFee,
            packagingFee,
            total: Math.ceil(totalCost)
        };
    }

    // --- åŠ å…¥æ¸…å–® ---
    function addToList() {
        const result = calculateFee();
        if (!result) { alert("è«‹è¼¸å…¥é‡é‡ï¼"); return; }

        const mId = document.getElementById('memberId').value.trim() || '-';
        const email = document.getElementById('memberEmail').value.trim() || '-';
        const manualNote = document.getElementById('manualNote').value.trim() || ''; 
        const batch = document.getElementById('batchName').value.trim() || getTimeString();

        const autoDetail = `é‹${result.shippingFee} + ä»£${result.collectionFee} + åŒ…${result.packagingFee}`;

        dataList.push({
            batch: batch,
            id: mId,
            email: email,
            countDesc: `${result.inputCount}å…¥ / ${result.packedCount}å‡º`, // é¡¯ç¤ºå…¥åº«èˆ‡å‡ºè²¨æ•¸
            weight: result.weight,
            autoDetail: autoDetail, 
            manualNote: manualNote,
            total: result.total
        });

        renderTable();

        // æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œä½†ä¿ç•™æ‰“åŒ…æ•¸é è¨­ç‚º1
        document.getElementById('smartInput').value = '';
        document.getElementById('weightInput').value = '';
        document.getElementById('manualNote').value = '';
        document.getElementById('memberId').value = ''; 
        document.getElementById('memberEmail').value = ''; 
        document.getElementById('packedCount').value = '1'; // é‡ç½®ç‚º 1
        
        updatePkgCount();
        document.getElementById('smartInput').focus();
    }

    function renderTable() {
        const tbody = document.getElementById('listBody');
        tbody.innerHTML = '';
        dataList.forEach((item, index) => {
            tbody.innerHTML += `
                <tr>
                    <td>${item.id}</td>
                    <td><small>${item.email}</small></td>
                    <td>${item.countDesc}<br><small>${item.weight}kg</small></td>
                    <td style="color:#666; font-size:0.85em;">${item.autoDetail}</td>
                    <td style="color:#666; font-size:0.85em;">${item.manualNote}</td>
                    <td style="color:#d63384;font-weight:bold">${item.total}</td>
                    <td><button class="btn-danger" onclick="removeRow(${index})">X</button></td>
                </tr>`;
        });
    }

    function removeRow(index) {
        dataList.splice(index, 1);
        renderTable();
    }

    function clearList() {
        if(confirm("ç¢ºå®šæ¸…ç©ºæ¸…å–®ï¼Ÿ")) { dataList = []; renderTable(); }
    }

    function getTimeString() {
        const d = new Date();
        return `${d.getMonth()+1}/${d.getDate()}`;
    }

    function copyExcelFormat() {
        if (dataList.length === 0) { alert("æ²’è³‡æ–™ï¼"); return; }

        let text = "";
        dataList.forEach(item => {
            text += `${item.batch}\t${item.id}\t${item.email}\t${item.countDesc}\t${item.weight}\t${item.autoDetail}\t${item.manualNote}\t${item.total}\n`;
        });
        const ta = document.getElementById('clipboardArea');
        ta.value = text;
        ta.select();
        document.execCommand('copy');
        alert(`å·²è¤‡è£½ ${dataList.length} ç­†è³‡æ–™ï¼`);
    }
</script>
</body>
</html>
